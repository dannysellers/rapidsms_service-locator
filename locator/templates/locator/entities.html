{% extends "base.html" %}
{% load static %}
{% load leaflet_tags %}
{#{% load render_table from django_tables2 %}#}

{% block title %}
    Defined entities
{% endblock title %}

{% block extra_stylesheets %}
    {% leaflet_css %}
{% endblock extra_stylesheets %}

{% block extra_javascript %}
    {% leaflet_js %}
{% endblock extra_javascript %}

{% block content %}
    <div class="row">
        <div class="col-md-6">
            <div id="all_entities_map" class="leaflet-container-default"></div>
            <script type="text/javascript">
                (function () {

                    function loadmap() {
                        var djoptions = {
                                    "layers": [["OSM", "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", "\u00a9 <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors"]],
                                    "minimap": false,
                                    "scale": "metric",
                                    "center": null,
                                    "attributionprefix": null,
                                    "zoom": null,
                                    "tilesextent": [],
                                    "extent": [[-90, -180], [90, 180]],
                                    "resetview": true,
                                    "srid": null,
                                    "overlays": [],
                                    "fitextent": true
                                },
                                options = {
                                    djoptions: djoptions, initfunc: loadmap,
                                    globals: false, callback: null
                                };
                        map = L.Map.djangoMap('all_entities_map', options);
                    }

                    var loadevents = ["load"];
                    if (loadevents.length === 0) loadmap();
                    else if (window.addEventListener) for (var i = 0; i < loadevents.length; i++) window.addEventListener(loadevents[i], loadmap, false);
                    else if (window.jQuery) jQuery(window).on(loadevents.join(' '), loadmap);

                })();
            </script>

        </div>
    </div>

    <div class="col-md-6">
        <div id="json-response">
        </div>
    </div>
    <div class="col-md-6">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" class="checkbox" id="checkAll"></th>
                {% for item in headers %}
                    <th>{{ item }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for entity in entity_list %}
                <tr>
                    <td><input type="checkbox" class="checkbox"></td>
                    <td><a href="#" id="{{ entity.location_id }}" class="entity_link">{{ entity.name }}</a></td>
                    <td>{{ entity.type }}</td>
                    <td>{{ entity.location }}</td>
                </tr>{% endfor %}
            </tbody>
        </table>
    </div>
    </div>

    <script src="{% static "js/search.js" %}"></script>
    <script>

        // AJAX methods
        $(".entity_link").click(function () {

            // TODO: Start with a clean slate
            // map.clearLayers();

            $.ajax({

                url: "/entity/" + this.id + "/",
                dataType: "text",
                type: "GET",
                // data: {species: $(this).val()},
                error: function (err) {

                    alert("Error: " + err.responseText.toString())

                },
                success: function (data) {

                    $("#json-response").html(data);
                    //geojson.clearLayers();

                    L.geoJson((JSON.parse(data)), {
                        //style: choroStyle,
                        //onEachFeature: onEachFeature
                    }).addTo(map);
                }
            });
        });


        $("#checkAll").click(function () {
            $('.checkbox').prop('checked',
                    $(this).prop('checked'));
        });
    </script>

{% endblock content %}